#!/usr/bin/env node

var SLICE_SYMBOL = '-'
var argv = process.argv.slice(1)
var options = [
        {},
        {
            key: 'port',
            alias: 'p',
            default: 8888
        }
    ]

if (argv.length > 1) {
    argv = argv.reduce(function(p, c, i, a) {
        p = typeof p === 'string' ? {} : p

        if (c.indexOf(SLICE_SYMBOL) > -1) {
            c = c.replace(SLICE_SYMBOL, '')
            c = c.replace(SLICE_SYMBOL, '')
            p[c] = undefined
        }

        if (p.hasOwnProperty(c) && 
            a[++i] && 
            a[i].indexOf(SLICE_SYMBOL) === -1) {
                p[c] = a[i]
        }

        return p
    })
}

options = options.reduce(function(p, c, i, a) {
    c.value = argv[c.key] || argv[c.alias] || c.default
    p[c.key] = c
    return p
})

if (Number.isNaN(parseInt(options.port.value, 10))) {
    console.log('port invalid')
    process.exit(0)
}

var fs       = require('fs')
var http     = require('http')
var connect  = require('connect')
var terminal = require('term.js')
var static   = require('serve-static')
var io       = require('socket.io')
var pty      = require('pty.js')


var app, io, term,
    buff = []

// create http server
app = connect()
app.use(terminal.middleware())
app.use(static(__dirname + '/../'))
app = http.createServer(app).listen(options.port.value, function() {
    console.log('Running at http://localhost:' + options.port.value)
})


// create socket server
io(app).on('connection', function(socket) {
    var handshakeData = socket.handshake.query

    // configure terminal
    term = pty.spawn(process.env.SHELL || '/bin/bash', [], {
        name: fs.existsSync('/usr/share/terminfo/x/xterm-256color') ? 'xterm-256color' : 'xterm',
        cols: parseInt(handshakeData.cols, 10) || 80,
        rows: parseInt(handshakeData.rows, 10) || 24,
        cwd: process.env.HOME
    })

    term.on('data', function(data) {
        return !socket
            ? buff.push(data)
            : socket.emit('data', data)
    })

    term.on('close', function() {
        socket && socket.disconnect()
    })

    socket.on('data', function(data) {
        term.write(data)
    })

    socket.on('disconnect', function() {
        socket = null
        term.end()
    })

    socket.on('resize', function(data) {
        term.resize(data[0], data[1])
    })

    while(buff.length) {
        socket.emit('data', buff.shift())
    }
})
